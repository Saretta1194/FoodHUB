{% extends "base.html" %}
{% block content %}
<h1 class="mb-3">Order #{{ order.id }}</h1>

<div class="row g-3">
  <!-- Colonna riepilogo -->
  <div class="col-12 col-lg-8">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h5">Order summary</h2>

        {% if order.items.all %}
          <div class="table-responsive mt-2">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Dish</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit price</th>
                  <th class="text-end">Line total</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items.all %}
                  <tr>
                    <td>{{ it.dish_name }}</td>
                    <td class="text-center">{{ it.quantity }}</td>
                    <td class="text-end">€ {{ it.unit_price|floatformat:2 }}</td>
                    <td class="text-end">€ {{ it.unit_price|mul:it.quantity|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">No items on this order.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Colonna stato / delivery -->
  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h5">Status</h2>
        <div class="mb-2">
          <div><strong>Order status:</strong> <span id="order-status" class="badge text-bg-secondary">{{ order.status }}</span></div>
          <div class="small text-muted mt-1">{{ order.created_at }}</div>
        </div>

        {% if delivery %}
          <hr>
          <div class="mb-2">
            <div><strong>Delivery status:</strong> <span id="delivery-status" class="badge text-bg-secondary">{{ delivery.status }}</span></div>
            {% if delivery.rider %}
              <div class="mt-1"><strong>Rider:</strong> <span id="rider-name">{{ delivery.rider.username }}</span></div>
            {% endif %}
            <div class="small text-muted mt-1">Assigned at: {{ delivery.assigned_at }}</div>
          </div>

          <hr>
          <h3 class="h6">Timeline</h3>
          <ul id="timeline" class="small mb-0">
            {% for ev in events %}
              <li data-at="{{ ev.created_at|date:'c' }}">{{ ev.created_at }} — {{ ev.event_type }} — {{ ev.message }}</li>
            {% empty %}
              <li>No events yet.</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="alert alert-info mt-3">No delivery created yet.</div>
        {% endif %}

        <div class="d-grid gap-2 mt-3">
          <a href="{% url 'orders:my_orders' %}" class="btn btn-outline-secondary">Back to My orders</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Polling JSON -->
<script>
  (function(){
    const url = "{% url 'orders:customer_order_status_json' order.id %}";
    function poll(){
      fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
        .then(r => r.json())
        .then(data => {
          // order status
          const os = document.getElementById('order-status');
          if (os && data.order_status) os.textContent = data.order_status;

          // delivery status
          const ds = document.getElementById('delivery-status');
          if (ds && data.delivery_status) ds.textContent = data.delivery_status;

          // rider
          const rn = document.getElementById('rider-name');
          if (rn && data.rider) rn.textContent = data.rider;

          // timeline
          const tl = document.getElementById('timeline');
          if (tl) {
            tl.innerHTML = '';
            if (!data.events || data.events.length === 0) {
              tl.innerHTML = '<li>No events yet.</li>';
            } else {
              data.events.forEach(ev => {
                const li = document.createElement('li');
                // ev.at (ISO), ev.type, ev.message
                try {
                  const when = new Date(ev.at);
                  li.textContent = when.toLocaleString() + " — " + ev.type + " — " + ev.message;
                } catch(e) {
                  li.textContent = ev.at + " — " + ev.type + " — " + ev.message;
                }
                tl.appendChild(li);
              });
            }
          }
        })
        .catch(() => {});
    }
    setInterval(poll, 10000);
  })();
</script>
{% endblock %}
